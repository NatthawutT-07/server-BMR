// generator client {
//   provider = "prisma-client-js"
// }

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  Int      @id @default(autoincrement())
  name                String   @unique
  password            String
  role                String   @default("user")
  enabled             Boolean  @default(true)
  lastPasswordChange  DateTime @default(now())
  refreshTokenVersion Int      @default(0)

  loginLogs LoginLog[]
}

model LoginLog {
  id        Int      @id @default(autoincrement())
  user      User?    @relation(fields: [userId], references: [id])
  userId    Int?
  ip        String?
  userAgent String?
  status    String // "success" | "failed"
  message   String?
  createdAt DateTime @default(now())
}

model Partners {
  id                       Int     @id @default(autoincrement())
  codeBP                   String?
  nameBP                   String?
  accountBalance           Float
  interfaceADA             String?
  interfaceEDI             String?
  brand                    String?
  paymentTermsCode         String?
  noOldBP                  String?
  taxGroup                 String?
  remarks                  String?
  idNoTwo                  String?
  gp                       String?
  dc                       String?
  email                    String?
  phoneOne                 String?
  phoneTwo                 String?
  billAddressType          String?
  billBlock                String?
  billBuildingFloorRoom    String?
  billCity                 String?
  billCountry              String?
  billCountryNo            String?
  billZipCode              String?
  branchBP                 Int
  billExchangeOnCollection String?
  billDefault              String?
  billState                String?
  billStreet               String?
  billStreetNo             String?
  remarkOne                String?
  groupCode                String?
  federalTaxId             String?
}

model ItemMinMax {
  id          Int    @id @default(autoincrement())
  branchCode  String
  codeProduct Int
  minStore    Int
  maxStore    Int

  @@unique([branchCode, codeProduct])
  @@index([branchCode, codeProduct])
}

model Stock {
  id          Int    @id @default(autoincrement())
  codeProduct Int
  branchCode  String
  quantity    Int

  @@unique([branchCode, codeProduct])
  @@index([branchCode, codeProduct])
}

model DataSync {
  key       String   @id // เช่น "stock"
  updatedAt DateTime @default(now())
  rowCount  Int?
}

model withdraw {
  id          Int    @id @default(autoincrement())
  codeProduct Int
  branchCode  String
  docNumber   String
  date        String
  docStatus   String
  reason      String
  quantity    Int
  value       Float

  @@index([branchCode, codeProduct])
  @@index([branchCode, docStatus, codeProduct])
}

model ListOfItemHold {
  id                  Int     @id @default(autoincrement())
  codeProduct         Int     @unique
  nameProduct         String?
  groupName           String?
  status              String?
  barcode             String?
  nameBrand           String?
  consingItem         String?
  purchasePriceExcVAT Float
  salesPriceIncVAT    Int
  preferredVandorCode String?
  preferredVandorName String?
  GP                  String?
  shelfLife           String?
  productionDate      String?
  vatGroupPu          String?

  @@unique([barcode])
  @@index([codeProduct])
}

model Tamplate {
  id         Int     @id @default(autoincrement())
  branchCode String
  shelfCode  String
  fullName   String?
  rowQty     Int
  type       String?

  @@unique([branchCode, shelfCode])
  @@index([branchCode, shelfCode, fullName])
}

model Sku {
  id          Int    @id @default(autoincrement())
  branchCode  String
  shelfCode   String
  rowNo       Int
  codeProduct Int
  index       Int

  @@unique([branchCode, shelfCode, rowNo, codeProduct])
  @@index([branchCode, shelfCode, rowNo, index])
  @@index([branchCode, shelfCode, index])
  @@index([branchCode, codeProduct]) // ✅  UserTemplateItem ไวขึ้น
}

model Gourmet {
  id           Int      @id @default(autoincrement())
  date         DateTime
  branch_code  String
  product_code String
  quantity     Int
  sales        Float
}

model Branch {
  id          Int    @id @default(autoincrement())
  branch_code String @unique
  branch_name String
  bills       Bill[]
}

model SalesChannel {
  id           Int    @id @default(autoincrement())
  channel_code String @unique
  channel_name String
  bills        Bill[]
}

model Customer {
  id            Int     @id @default(autoincrement())
  customer_code String  @unique
  customer_name String?
  bills         Bill[]
}

model Product {
  id            Int        @id @default(autoincrement())
  product_code  String
  product_name  String
  product_brand String
  billItems     BillItem[]

  @@unique([product_code])
}

model Bill {
  id                   Int      @id @default(autoincrement())
  branchId             Int
  salesChannelId       Int
  customerId           Int?
  date                 DateTime
  bill_number          String   @unique
  doc_type             String
  pos_type             String
  reference_doc        String?
  value_excl_tax       Float
  vat                  Float
  end_bill_discount    Float
  total_after_discount Float
  rounding             Float
  total_sales          Float
  total_payment        Float

  payments BillPayment[]

  branch       Branch       @relation(fields: [branchId], references: [id])
  customer     Customer?    @relation(fields: [customerId], references: [id])
  salesChannel SalesChannel @relation(fields: [salesChannelId], references: [id])
  billItems    BillItem[]

  @@index([branchId, doc_type, date])
  @@index([date])
  @@index([branchId, date])
  @@index([salesChannelId, date])
  @@index([customerId, date])
  @@index([doc_type, date])
  @@index([date, id])
}

model BillPayment {
  id               Int     @id @default(autoincrement())
  billId           Int
  amount           Float
  payment_method   String?
  bank             String?
  reference_number String?

  bill Bill @relation(fields: [billId], references: [id], onDelete: Cascade)

  // กันซ้ำแบบ “พอประมาณ” (ถ้ากลัวชนกันค่อยปรับเพิ่ม)
  @@unique([billId, amount, payment_method, bank, reference_number])
  @@index([billId])
  @@index([payment_method])
  @@index([bank])
}

model BillItem {
  id             Int     @id @default(autoincrement())
  billId         Int
  productId      Int
  quantity       Float
  unit           String?
  price_per_unit Float
  sales_amount   Float
  discount       Float
  net_sales      Float
  bill           Bill    @relation(fields: [billId], references: [id])
  product        Product @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([billId])
  // Index เสริมสำหรับ dashboard product (JOIN Bill + GROUP BY product)
  @@index([billId, productId])
}

model PogRequest {
  id          Int     @id @default(autoincrement())
  branchCode  String
  action      String // "add" | "swap" | "delete"
  barcode     String
  productName String?

  // Current position
  fromShelf String?
  fromRow   Int?
  fromIndex Int?

  // Target position (for add/swap)
  toShelf String?
  toRow   Int?
  toIndex Int?

  // For swap - second product
  swapBarcode     String?
  swapProductName String?

  status    String   @default("pending") // pending | approved | rejected | completed
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchCode, status])
  @@index([status])
  @@index([createdAt])
}

// ✅ เก็บสถานะการอัพเดท shelf ของแต่ละสาขา (สำหรับแจ้งเตือน mobile)
model ShelfUpdate {
  id         Int      @id @default(autoincrement())
  branchCode String   @unique
  hasUpdate  Boolean  @default(true)
  updatedAt  DateTime @updatedAt
  updatedBy  String?

  @@index([branchCode])
}

// ✅ เก็บ log รายละเอียดการเปลี่ยนแปลง shelf (add/delete/move)
model ShelfChangeLog {
  id          Int     @id @default(autoincrement())
  branchCode  String
  shelfCode   String
  updateId    String // UUID group บันทึกพร้อมกัน
  action      String // "add" | "delete" | "move"
  codeProduct Int
  productName String?

  // ตำแหน่งเดิม (สำหรับ delete/move)
  fromRow   Int?
  fromIndex Int?

  // ตำแหน่งใหม่ (สำหรับ add/move)
  toRow   Int?
  toIndex Int?

  createdAt DateTime @default(now())
  createdBy String?

  // ✅ สำหรับ acknowledge ทีละตัว
  acknowledged   Boolean   @default(false)
  acknowledgedAt DateTime?

  @@index([branchCode, shelfCode])
  @@index([branchCode, createdAt])
  @@index([branchCode, acknowledged])
  @@index([updateId])
}
